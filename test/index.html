<!DOCTYPE html>
<html lang="en">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        var storage_host = "";
        var oauth_host = "";
        var email = "";
        var password = "test1!";

        function log_down() {
            document.body.scrollTop = document.body.scrollHeight;
        }

        function set_host() {
            var host_ = document.getElementById("host_selc").value;
            switch (host_) {
                case "local":
                    storage_host = "http://localhost:3004";
                    oauth_host = "http://localhost:3001";
                    break;
                case "qa":
                    storage_host = "https://storage.qa.belf.xyz";
                    oauth_host = "https://oauth.qa.belf.xyz";
                    break;
                case "prod":
                    storage_host = "https://storage.belf.xyz";
                    oauth_host = "https://oauth.belf.xyz";
                    break;
                default:
                    break;
            }
        }

        function set_user() {
            var host_ = document.getElementById("user_selc").value;
            switch (host_) {
                case "user01":
                    email = "user01@test.com";
                    break;
                case "user02":
                    email = "user02@test.com";
                    break;
                case "올바르지 않은 유저 정보":
                    email = "";
                    break;
                default:
                    break;
            }
        }

        function clear_log() {
            document.getElementById("log").innerHTML = "";
        }
        function log_s(msg) {
            document.getElementById("log").innerHTML += `<p>${msg}</p>`;
            document.getElementById("log").scrollTop =
                document.getElementById("log").scrollHeight;
        }
        function do_login(callback) {
            axios({
                method: "post",
                url: `${oauth_host}/api/users/login`,
                headers: { "Content-Type": "application/json" },
                data: {
                    email: email,
                    password: password,
                },
            })
                .then((response) => {
                    log_s(`login success - ${oauth_host}`);
                    callback(response.data["accessToken"]);
                })
                .catch((error) => {
                    log_s(`login fail - ${error}`);
                });
        }
        function onBtnClick_axios() {
            var file = document.getElementById("input").files[0];

            if (file) {
                do_login((token) => {
                    let config = {
                        method: "post",
                        url: `${storage_host}/api/v1/upload`,
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": file.type,
                        },
                        data: file,
                        onUploadProgress: (progressEvent) => {
                            log_s(
                                `file upload.. ${parseInt(
                                    (progressEvent.loaded * 100) /
                                        progressEvent.total
                                )}%`
                            );
                        },
                    };
                    axios(config)
                        .then((response) => {
                            clear_log();
                            log_s(`file upload success - ${storage_host}`);
                            loc = response.headers["location"];
                            if (loc) {
                                log_s(`download image - ${storage_host}${loc}`);
                                var file_id = String(loc).split(
                                    "/api/v1/download?file_id="
                                )[1];
                                document.getElementById("file_id").value =
                                    file_id;

                                document.getElementById(
                                    "result_img"
                                ).src = `${storage_host}${loc}`;
                            }
                        })
                        .catch((error) => {
                            log_s(`file upload fail - ${error}`);
                            document.getElementById("result_img").src = ``;
                        });
                });
            } else {
                log_s("error : please upload file first");
            }
        }

        function get_info() {
            var file_id = document.getElementById("file_id").value;
            if (file_id) {
                let config = {
                    method: "get",
                    url: `${storage_host}/api/v1/info?file_id=${file_id}`,
                };
                axios(config)
                    .then((response) => {
                        var file_info = response.data;
                        log_s(JSON.stringify(file_info, null, 5));
                    })
                    .catch((error) => {
                        log_s(error);
                    });
            }
        }

        function delete_file() {
            var file_id = document.getElementById("file_id").value;
            if (file_id) {
                do_login((token) => {
                    let config = {
                        method: "delete",
                        url: `${storage_host}/api/v1/delete?file_id=${file_id}`,
                        headers: {
                            Authorization: `Bearer ${token}`,
                        },
                    };

                    axios(config)
                        .then((response) => {
                            log_s(`file_id=${file_id} - file delete success.`);
                        })
                        .catch((error) => {
                            log_s(
                                `file delete error - ${
                                    error.response.data["error"]
                                        ? error.response.data["error"]
                                        : error
                                }`
                            );
                        });
                });
            }
        }
        function get_version() {
            let config = {
                method: "get",
                url: `${storage_host}/api/v1/default/version`,
            };

            axios(config)
                .then((response) => {
                    log_s(`${storage_host} - VERSION=${response.data}`);
                })
                .catch((error) => {
                    log_s(
                        `error - ${
                            error.response.data["error"]
                                ? error.response.data["error"]
                                : error
                        }`
                    );
                });
        }

        function get_env() {
            let config = {
                method: "get",
                url: `${storage_host}/api/v1/default/env`,
            };

            axios(config)
                .then((response) => {
                    log_s(`${JSON.stringify(response.data, null, 5)}`);
                })
                .catch((error) => {
                    log_s(
                        `error - ${
                            error.response.data["error"]
                                ? error.response.data["error"]
                                : error
                        }`
                    );
                });
        }
        function get_name() {
            let config = {
                method: "get",
                url: `${storage_host}/api/v1/default`,
            };

            axios(config)
                .then((response) => {
                    log_s(
                        `${storage_host} - ${JSON.stringify(
                            response.data,
                            null,
                            5
                        )}`
                    );
                })
                .catch((error) => {
                    log_s(
                        `error - ${
                            error.response.data["error"]
                                ? error.response.data["error"]
                                : error
                        }`
                    );
                });
        }

        function get_ok() {
            let config = {
                method: "get",
                url: `${storage_host}/api/v1/default/ping`,
            };

            axios(config)
                .then((response) => {
                    log_s(`${storage_host} - OK`);
                })
                .catch((error) => {
                    log_s(
                        `error - ${
                            error.response.data["error"]
                                ? error.response.data["error"]
                                : error
                        }`
                    );
                });
        }
    </script>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <body>
        <div>
            서버 선택 :
            <select
                name="host"
                id="host_selc"
                onchange="
            set_host()"
            >
                <option value="">-</option>
                <option value="local">로컬 개발환경</option>
                <option value="qa">QA 서버</option>
                <option value="prod">PROD 서버</option>
            </select>
            유저 선택 :
            <select
                name="user"
                id="user_selc"
                onchange="
            set_user()"
            >
                <option value="">-</option>
                <option value="test_1">user01</option>
                <option value="test_2">user02</option>
                <option value="test_3">없는 유저</option>
            </select>
        </div>
        <hr />
        <input id="input" type="file" placeholder="image/*" />
        <button onclick="onBtnClick_axios()">업로드</button>
        <input id="file_id" , type="text" placeholder="file_id" />
        <button onclick="get_info()">정보 조회</button>
        <button onclick="delete_file()">삭제 요청</button>
        <hr />
        <button onclick="get_version()">서버 버전 조회</button>
        <button onclick="get_env()">서버 환경 조회</button>
        <button onclick="get_name()">서버 이름 조회</button>
        <button onclick="get_ok()">서버 응답 조회</button>
        <hr />
        <div>
            <img id="result_img" width="200px" />
        </div>
        <hr />
        <div>
            <button onclick="clear_log()">로그 초기화</button>
        </div>
        <hr />
        <pre>
            <div id="log" style="overflow:scroll; height:750px;"></div>
        </pre>
        <hr />
    </body>
</html>
